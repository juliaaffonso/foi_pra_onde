<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <title>Foi pra onde?</title>

    <link rel="stylesheet" href="style.css">
    <script defer src="script.js"></script>

    <style>
        /* General Styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #dfe3b9;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            text-align: center;
        }

        /* Header Section */
        header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }

        .header-visuals {
            display: flex;
            align-items: flex-end;
            /* aligns SVG and gif bottom edges */
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .svg-logo {
            width: 470px;
            height: auto;
            max-width: 150%;
            align-self: flex-end;
            margin-left: 15px;
        }

        .gif-local {
            height: 270px;
            width: auto;
            flex-shrink: 0;
        }

        .header-text {
            max-width: 600px;
            text-align: center;
        }

        .header-text h4 {
            color: #606770;
            font-size: 1rem;
            margin-top: 20px;
            margin-bottom: 0;
        }

        .header-text p {
            font-size: 0.9rem;
            color: #606770;
            opacity: 0.6;
            margin-top: 7px;
            margin-bottom: 20px;
            font-style: italic;
        }

        p a {
            color: #149e59;
            /* Matches your green button */
            text-decoration: none;
            /* Removes the underline */
            font-weight: 500;
            transition: color 0.3s ease;
        }

        p a:hover {
            text-decoration: underline;
            /* Optional hover effect */
            color: #0c5014;
            /* Darker green on hover */
        }

        .divider {
            height: 3px;
            background-color: #ccc;
            margin: 25px 0;
            /* Adjusted margin */
            width: 100%;
        }

        /* SVG Text fade transition for rest parts */
        #part-rest1,
        #part-rest2,
        #part-rest3,
        #part-rest4,
        #part-rest5 {
            transition: opacity 1s ease;
            opacity: 0;
        }

        /* Main Content */

        h6 {
            color: #606770;
            font-size: 1rem;
            margin-top: 8px;
            margin-bottom: 25px;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 15px;
            flex-wrap: wrap;
        }

        .date-picker,
        .format-selector {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        input[type="date"],
        select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
            min-width: 150px;
        }

        .president-selector-container select {
            min-width: 120px;
            width: 120px;
        }

        /* Download Button */
        #downloadBtn {
            background-color: #149e59;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 0;
        }

        #downloadBtn:hover {
            background-color: #0c5014;
            transform: translateY(-2px);
        }

        #downloadBtn:active {
            transform: translateY(0);
        }

        /* Message Area */
        #message {
            margin-top: 20px;
            font-weight: 500;
            min-height: 20px;
        }

        /* Search Section Styling */
        .search-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .search-controls {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }

        #searchInput {
            padding: 10px;
            width: 100%;
            max-width: 450px;
            /* Adjusted width */
            font-size: 1rem;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        .search-input-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex: 1;
            min-width: 200px;
        }


        /* Results Table Styling */
        #results table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
            margin-top: 5px;
        }

        #results th,
        #results td {
            padding: 8px;
            border: 1px solid #ccc;
            text-align: left;
            vertical-align: top;
        }

        #results thead {
            background-color: #f0f0f0;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-visuals">
                <svg id="Camada_1" data-name="Camada 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 516.38 239.89"
                    class="svg-logo">
                    <defs>
                        <style>
                            .cls-1,
                            .cls-2 {
                                fill: #1d1d1b;
                                font-family: Niramit-Bold, Niramit;
                                font-weight: 700;
                            }

                            .cls-3 {
                                font-size: 56px;
                            }

                            .cls-4 {
                                font-size: 53px;
                            }

                            .cls-5 {
                                letter-spacing: -.02em;
                            }

                            .cls-6 {
                                letter-spacing: -.04em;
                            }

                            .cls-7 {
                                letter-spacing: 0em;
                            }

                            .cls-2 {
                                font-size: 176px;
                                letter-spacing: .02em;
                                opacity: .9;
                            }

                            .cls-8 {
                                letter-spacing: .02em;
                            }
                        </style>
                    </defs>

                    <text class="cls-1" transform="translate(0 76.49)">
                        <tspan class="cls-4">
                            <tspan id="part-where1" x="0" y="0">where</tspan>
                            <tspan id="part-rest1"> did the</tspan>

                        </tspan>
                        <tspan class="cls-3">
                            <tspan id="part-rest2" class="cls-8" x="0" y="67.2">p</tspan>
                            <tspan id="part-rest3" class="cls-5" x="34.16" y="67.2">r</tspan>
                            <tspan id="part-rest4" class="cls-7" x="56.05" y="67.2">e</tspan>
                            <tspan id="part-rest5" class="cls-8" x="87.13" y="67.2">sident go</tspan>
                        </tspan>
                    </text>

                    <text class="cls-2" transform="translate(332.43 149.6)">
                        <tspan id="part-question">?</tspan>
                    </text>
                </svg>

                <img src="gifs/travolta-waiting.gif" alt="Travolta-waiting" class="gif-local" />
            </div>

            <div class="header-text">
                <h4>This page provides datasets of all Brazilian presidential meetings since 2016.</h4>
                <p>(Data from the current presidential term is updated daily. For full accuracy, always cross-check it
                    with the
                    <a
                        href="https://www.gov.br/planalto/pt-br/acompanhe-o-planalto/agenda-do-presidente-da-republica-lula">official
                        agenda</a>. Data from previous terms comes from <a
                        href="https://www.biblioteca.presidencia.gov.br/presidencia/ex-presidentes"> archived
                        sources</a>.)
                </p>
            </div>
        </header>

        <div class="divider"></div>

        <main>
            <h6>Choose the dates, pick a format, and hit the green button below. â¬‡</h6>

            <form id="downloadForm">
                <div class="controls">
                    <div class="format-selector president-selector-container">
                        <label for="presidentSelect">President:</label>
                        <select id="presidentSelect" name="presidentSelect">
                            <option value="lula">Lula</option>
                            <option value="bolsonaro">Bolsonaro</option>
                            <option value="temer">Temer</option> </select>
                        </select>
                    </div>

                    <div class="date-picker">
                        <label for="startDate">Start Date:</label>
                        <input type="date" id="startDate" name="startDate" min="2023-01-01" required />
                    </div>

                    <div class="date-picker">
                        <label for="endDate">End Date:</label>
                        <input type="date" id="endDate" name="endDate" required />
                    </div>

                    <div class="format-selector">
                        <label for="fileFormat">Format:</label>
                        <select id="fileFormat" name="fileFormat">
                            <option value="csv">CSV</option>
                            <option value="xlsx">XLSX</option>
                        </select>
                    </div>

                    <button type="submit" id="downloadBtn">Download ðŸ“¥</button>
                </div>
            </form>

            <div id="message"></div>
        </main>

        <div class="divider"></div>

        <div class="search-container">
            <h6>Search here ðŸ”Ž</h6>
            <div class="search-controls">
                <div class="format-selector">
                    <label for="searchPresident">President:</label>
                    <select id="searchPresident">
                        <option value="lula">Lula</option>
                        <option value="bolsonaro">Bolsonaro</option>
                        <option value="temer">Temer</option> </select>
                    </select>
                </div>
                <div class="format-selector">
                    <label for="searchField">Choose:</label>
                    <select id="searchField"></select>
                </div>

                <div class="search-input-wrapper">
                    <label for="searchInput" style="visibility: hidden;">Search</label>
                    <input type="text" id="searchInput" placeholder="Type here">
                </div>
            </div>
        </div>

        <div id="results"></div>

        <script>
            // =================================================================
            // CONFIGURATION
            // =================================================================
            // This is the single source of truth for all president-specific settings.
            const presidentConfig = {
                "lula": {
                    // Date settings for the download form
                    minDate: "2023-01-01",
                    maxDate: new Date().toISOString().slice(0, 10), // Today's date
                    // Data file name
                    fileName: "all_data.json",
                    // The key in the JSON file that holds the date value
                    dateKey: "data",
                    // Options for the search field dropdown
                    searchFields: [
                        { value: "participantes", text: "Participantes" },
                        { value: "compromisso", text: "ReuniÃ£o" },
                        { value: "description", text: "ReuniÃ£o" }
                    ],
                    // Defines the columns for the results table
                    displayColumns: [
                        { header: "Data", key: "data" },
                        { header: "Data", key: "date" },
                        { header: "Event", key: "compromisso" },
                        { header: "HorÃ¡rio", key: "inicio" },
                        { header: "Location", key: "local" },
                        { header: "Participants", key: "participantes" }
                    ]
                },
                "bolsonaro": {
                    minDate: "2019-01-01",
                    maxDate: "2022-12-31",
                    fileName: "bolsonaro_agenda.json",
                    dateKey: "date",
                    searchFields: [
                        { value: "compromisso", text: "Event title" }
                    ],
                    displayColumns: [
                        { header: "Date", key: "date" },
                        { header: "Event", key: "compromisso" },
                        { header: "Time", key: "time" }
                    ]
                },
                "temer": {
                    minDate: "2016-08-31",
                    maxDate: "2018-12-31",
                    fileName: "temer_agenda.json",
                    dateKey: "date",
                    searchFields: [
                        { value: "description", text: "Compromisso" }
                    ],
                    displayColumns: [
                        { header: "Date", key: "date" },
                        { header: "Event", key: "description" },
                        { header: "Time", key: "time" }
                    ]
                }
            };

            // =================================================================
            // GLOBAL VARIABLES & DOM ELEMENTS
            // =================================================================
            let allData = [];
            let currentPresident = "lula"; // Default president on page load

            const startDateInput = document.getElementById("startDate");
            const endDateInput = document.getElementById("endDate");
            const downloadForm = document.getElementById("downloadForm");
            const messageDiv = document.getElementById("message");
            const searchInput = document.getElementById("searchInput");
            const resultsDiv = document.getElementById("results");
            const presidentSelect = document.getElementById("presidentSelect");
            const searchPresident = document.getElementById("searchPresident");
            const searchField = document.getElementById("searchField");

            // =================================================================
            // FUNCTIONS
            // =================================================================

            /**
             * Updates the date input constraints based on the selected president's term.
             */
            function updateDateConstraints(president) {
                const config = presidentConfig[president];
                if (!config) return;

                startDateInput.min = config.minDate;
                startDateInput.max = config.maxDate;
                endDateInput.min = config.minDate;
                endDateInput.max = config.maxDate;

                if (!startDateInput.value || startDateInput.value < config.minDate || startDateInput.value > config.maxDate) {
                    startDateInput.value = config.minDate;
                }
                if (!endDateInput.value || endDateInput.value < config.minDate || endDateInput.value > config.maxDate) {
                    endDateInput.value = config.maxDate;
                }
            }

            /**
             * Loads the JSON data file for the selected president.
             */
            async function loadPresidentData(president) {
                messageDiv.textContent = "Loading data...";
                const config = presidentConfig[president];
                if (!config || !config.fileName) {
                    messageDiv.textContent = `Error: Configuration or file for ${president} not found.`;
                    messageDiv.style.color = "red";
                    return [];
                }

                try {
                    const response = await fetch(`data/${config.fileName}`);
                    if (!response.ok) throw new Error("Network response was not ok.");
                    const data = await response.json();
                    messageDiv.textContent = "";
                    return data;
                } catch (error) {
                    messageDiv.textContent = `Error loading data: ${error.message}`;
                    messageDiv.style.color = "red";
                    return [];
                }
            }

            /**
             * Filters the global `allData` array by a given date range.
             */
            function filterByDate(start, end) {
                const { dateKey } = presidentConfig[currentPresident];
                return allData.filter(entry => {
                    const entryDate = entry[dateKey];
                    return entryDate >= start && entryDate <= end;
                });
            }

            /**
             * Converts an array of objects to a CSV string.
             */
            function convertToCSV(data) {
                if (data.length === 0) return "";
                const headers = Object.keys(data[0]);
                const csvRows = [headers.join(",")];
                data.forEach(row => {
                    const values = headers.map(header => `"${String(row[header]).replace(/"/g, '""')}"`);
                    csvRows.push(values.join(","));
                });
                return csvRows.join("\n");
            }

            /**
             * Triggers a browser download for a blob of content.
             */
            function downloadBlob(content, filename, type) {
                const blob = new Blob([content], { type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            /**
             * Populates the search field dropdown with options for the selected president.
             */
            function updateSearchFieldOptions(president) {
                searchField.innerHTML = ""; // Clear existing options
                const config = presidentConfig[president];
                if (!config) return;

                config.searchFields.forEach(field => {
                    const option = document.createElement("option");
                    option.value = field.value;
                    option.textContent = field.text;
                    searchField.appendChild(option);
                });
            }

            /**
             * Displays filtered data in a dynamically generated table in the results div.
             */
            function displayFilteredData(data) {
                if (data.length === 0) {
                    resultsDiv.innerHTML = "<p>No matches found.</p>";
                    return;
                }

                const config = presidentConfig[currentPresident];
                if (!config) return;

                const tableHeaders = config.displayColumns.map(col => `<th>${col.header}</th>`).join('');
                const tableRows = data.map(entry => {
                    const cells = config.displayColumns.map(col => `<td>${entry[col.key] || ""}</td>`).join('');
                    return `<tr>${cells}</tr>`;
                }).join('');

                resultsDiv.innerHTML = `
            <table>
                <thead><tr>${tableHeaders}</tr></thead>
                <tbody>${tableRows}</tbody>
            </table>`;
            }

            /**
             * Handles the logic for changing the current president.
             */
            async function handlePresidentChange(newPresident) {
                currentPresident = newPresident;
                presidentSelect.value = newPresident;
                searchPresident.value = newPresident;

                updateDateConstraints(newPresident);
                updateSearchFieldOptions(newPresident);
                allData = await loadPresidentData(newPresident);

                searchInput.value = "";
                resultsDiv.innerHTML = "";
                messageDiv.textContent = "";
            }

            // =================================================================
            // EVENT LISTENERS
            // =================================================================

            downloadForm.addEventListener("submit", (event) => {
                event.preventDefault();
                messageDiv.textContent = "";

                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);
                const fileFormat = document.getElementById("fileFormat").value;

                if (endDate < startDate) {
                    messageDiv.textContent = "Error: End date cannot be earlier than the start date.";
                    messageDiv.style.color = "red";
                    return;
                }

                const filteredData = filterByDate(startDateInput.value, endDateInput.value);

                if (filteredData.length === 0) {
                    messageDiv.textContent = "No data found for the selected range.";
                    return;
                }

                const fileName = `${currentPresident}_agenda_${startDateInput.value}_to_${endDateInput.value}`;

                if (fileFormat === "csv") {
                    const csv = convertToCSV(filteredData);
                    const bom = "\uFEFF"; // UTF-8 BOM
                    downloadBlob(bom + csv, `${fileName}.csv`, "text/csv;charset=utf-8;");
                } else if (fileFormat === "xlsx") {
                    const worksheet = XLSX.utils.json_to_sheet(filteredData);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Agenda");
                    XLSX.writeFile(workbook, `${fileName}.xlsx`);
                }

                messageDiv.textContent = `Downloaded ${filteredData.length} records.`;
                messageDiv.style.color = "green";
            });

            searchInput.addEventListener("input", () => {
                const query = searchInput.value.trim().toLowerCase();
                const field = searchField.value;

                if (!query) {
                    resultsDiv.innerHTML = "";
                    return;
                }

                const filtered = allData.filter(entry => {
                    const target = (entry[field] || "").toLowerCase();
                    return target.includes(query);
                });

                const { dateKey } = presidentConfig[currentPresident];
                filtered.sort((a, b) => b[dateKey].localeCompare(a[dateKey]));

                displayFilteredData(filtered);
            });

            presidentSelect.addEventListener("change", () => handlePresidentChange(presidentSelect.value));
            searchPresident.addEventListener("change", () => handlePresidentChange(searchPresident.value));

            // =================================================================
            // INITIAL PAGE LOAD
            // =================================================================

            document.addEventListener("DOMContentLoaded", () => {
                handlePresidentChange(currentPresident);

                setTimeout(() => {
                    const idsToAnimate = ["part-rest1", "part-rest2", "part-rest3", "part-rest4", "part-rest5"];
                    idsToAnimate.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.style.opacity = "1";
                    });
                }, 500);
            });
        </script>
</body>

</html>