<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <title>Foi pra onde?</title>

    <link rel="stylesheet" href="https://use.typekit.net/wnf5xzg.css">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RD9PQ2CF9F"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-RD9PQ2CF9F');
    </script>

    <!-- Load D3 from CDN -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <script defer src="quiz.js"></script>
    <script defer src="script.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

    <style>
        /* General Styling */
        body {
            font-family:
                "minion-variable-concept",
                /* Adobe font */
                "Georgia",
                /* Common serif with good contrast */
                "Times New Roman",
                /* Classic fallback */
                Cambria,
                /* Modern serif available on Windows */
                "Palatino Linotype",
                /* Extra fallback for older systems */
                "Book Antiqua",
                /* Another classic serif */
                serif,
                /* Generic fallback */
                Roboto, Helvetica, Arial, sans-serif;
            /* Optional sans fallback if serif fails */

            background-color: #dfe3b9;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            text-align: center;
        }

        /* Header Section */
        header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }

        .header-visuals {
            display: flex;
            align-items: flex-end;
            /* aligns SVG and gif bottom edges */
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .svg-logo {
            width: 470px;
            height: auto;
            max-width: 150%;
            align-self: flex-end;
            margin-left: 15px;
        }

        .gif-local {
            height: 270px;
            width: auto;
            flex-shrink: 0;
        }

        .header-text {
            max-width: 600px;
            text-align: center;
        }

        .header-text h4 {
            color: #606770;
            font-size: 1rem;
            margin-top: 20px;
            margin-bottom: 0;
        }

        .header-text p {
            font-size: 0.9rem;
            color: #606770;
            opacity: 0.6;
            margin-top: 20px;
            margin-bottom: 20px;
            font-style: italic;
        }

        p a {
            color: #149e59;
            /* Matches your green button */
            text-decoration: none;
            /* Removes the underline */
            font-weight: 500;
            transition: color 0.3s ease;
        }

        p a:hover {
            text-decoration: underline;
            /* Optional hover effect */
            color: #0c5014;
            /* Darker green on hover */
        }

        .divider {
            height: 3px;
            background-color: #ccc;
            margin: 25px 10px;
            /* Adjusted margin */
            width: 100%;
        }

        /* Main Content */

        h6 {
            color: #606770;
            font-size: 1rem;
            margin-top: 25px;
            margin-bottom: 25px;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 15px;
            flex-wrap: wrap;
        }

        .date-picker,
        .format-selector {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        input[type="date"],
        select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
            min-width: 150px;
        }

        .president-selector-container select {
            min-width: 120px;
            width: 120px;
        }

        /* Download Button */
        #downloadBtn {
            background-color: #149e59;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 0;
        }

        #downloadBtn:hover {
            background-color: #0c5014;
            transform: translateY(-2px);
        }

        #downloadBtn:active {
            transform: translateY(0);
        }

        /* Message Area */
        #message {
            margin-top: 20px;
            font-weight: 500;
            min-height: 20px;
        }

        /* Search Section Styling */
        .search-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .search-controls {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }

        #searchInput {
            padding: 10px;
            width: 100%;
            max-width: 450px;
            /* Adjusted width */
            font-size: 1rem;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        .search-input-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex: 1;
            min-width: 200px;
        }


        /* Results Table Styling */
        #results table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
            margin-top: 5px;
        }

        #results th,
        #results td {
            padding: 8px;
            border: 1px solid #ccc;
            text-align: left;
            vertical-align: top;
        }

        #results thead {
            background-color: #f0f0f0;
            font-weight: bold;
        }

        /* Add this for smooth scrolling on the whole page */
        html {
            scroll-behavior: smooth;
        }

        /* Styling for the button container */
        .navigation-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* Styling for the new navigation buttons */
        .nav-btn {
            background-color: #149e59;
            /* A neutral background */
            color: white;
            /* Dark text */
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            margin-bottom: 20px;
        }

        /* Hover effect to make them interactive */
        .nav-btn:hover {
            background-color: #0c5014;
            /* Green on hover */
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Styling for the new placeholder sections */
        .content-section {
            padding-top: 20px;
            min-height: 200px;
            /* Ensures the section has some height for scrolling */
        }

        /* Styling for the bubble chart tooltip */
        .tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            height: auto;
            padding: 8px;
            font: 12px sans-serif;
            background: #333;
            color: white;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            /* Allows mouse events to pass through to the circle */
            opacity: 0;
            /* Initially hidden */
            transition: opacity 0.2s;
        }

        /* This creates a container with a fixed 4:3 aspect ratio (800 / 600) */
        .charts-wrapper {
            position: relative;
            width: 100%;
            /* This correctly sets the uniform aspect ratio */
            aspect-ratio: 800 / 600;
            border: 1px solid #eee;
            margin-top: 15px;
            /* Optional: helps visualize the container */
            border-radius: 8px;
            overflow: hidden;
        }

        /* This positions each chart to fill the wrapper and sets up the fade effect */
        .charts-wrapper .chart {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Centering the chart content inside */
            display: flex;
            justify-content: center;
            align-items: center;
            /* Your fade transition */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease-in-out;
        }

        /* This makes the active chart visible */
        .charts-wrapper .chart.active {
            opacity: 1;
            visibility: visible;
        }

        /* Styles for SVGs and IMGs inside the charts */
        /* NOTE: I made this selector more general so it applies to ALL charts, not just one ID. */
        .chart svg,
        .chart img {
            max-width: 100%;
            max-height: 100%;
            /* Scales the image to fit without distortion */
            object-fit: contain;
        }

        /* Styling for the pagination dots container */
        .chart-dots {
            text-align: center;
            padding-top: 15px;
            display: none;
            /* Hidden by default on desktop */
        }

        /* Individual dot styling */
        .chart-dots .dot {
            display: inline-block;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            /* Makes it a circle */
            background-color: #ccc;
            /* Inactive dot color */
            margin: 0 5px;
            /* Spacing between dots */
            transition: background-color 0.3s ease;
        }

        /* Style for the active dot */
        .chart-dots .dot.active {
            background-color: #149e59;
            /* Your theme's green color */
        }

        /* Mobile Styles */
        /* This will override the desktop styles on screens 768px or smaller */

        @media (max-width: 768px) {

            /* Make the dots visible on mobile */
            .chart-dots {
                display: block;
            }

            .charts-wrapper {
                display: flex;
                overflow-x: auto;
                scroll-snap-type: x mandatory;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                /* Hides in Firefox */
            }

            .charts-wrapper::-webkit-scrollbar {
                display: none;
                /* Chrome, Safari */
            }

            /* Override the chart styles to lay them out side-by-side */
            .charts-wrapper .chart {
                /* Revert positioning and visibility for scrolling */
                position: static;
                opacity: 1 !important;
                visibility: visible !important;
                /* Set up flex items for the scroll container */
                flex-shrink: 0;
                width: 100%;
                height: auto;
                /* Allow height to be determined by aspect-ratio */
                scroll-snap-align: start;
            }

            /* Hide the navigation buttons on mobile */
            #prevChart,
            #nextChart {
                display: none;
            }
        }

        /* CSS rule for the quiz hint */
        /* Your final CSS rules */

        #quiz-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #eee;
        }

        .quiz-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        #quiz-container input[type="text"] {
            width: 300px;
            font-size: 18px;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            /* Added a subtle border */
        }

        .quiz-controls button {
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            background-color: #149e59;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 20px
        }

        .quiz-controls button:hover {
            background-color: #0c5014;
        }

        .quiz-hint {
            color: #6c757d;
            font-size: 0.9em;
            font-style: italic;
            margin-top: -10px;
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-visuals">
                <img src="logo/logo_pt.svg" alt="Logo" class="svg-logo">

                <img src="gifs/travolta-waiting.gif" alt="Travolta-waiting" class="gif-local" />
            </div>

            <div class="header-text">
                <h4>Esta página disponibiliza planilhas com dados de reuniões presidenciais no Brasil desde
                    2011.</h4>
                <p>(As informações da <a
                        href="https://www.gov.br/planalto/pt-br/acompanhe-o-planalto/agenda-do-presidente-da-republica-lula">
                        agenda oficial </a>
                    do atual presidente são atualizadas diariamente. Dados de mandatos anteriores foram obtidos do <a
                        href="https://www.biblioteca.presidencia.gov.br/presidencia/ex-presidentes"> arquivo da
                        Presidência da República</a>.)
                </p>
            </div>
        </header>

        <div class="navigation-buttons">
            <a href="#download-section" class="nav-btn">Download 📥</a>
            <a href="#search-section" class="nav-btn">Busca rápida 🔎</a>
            <a href="#quiz-section" class="nav-btn">Quiz 🧩</a>
            <a href="#dataviz-section" class="nav-btn">DataViz 📊</a>
        </div>

        <div class="divider"></div>

        <main id="download-section">
            <h6>Escolha as datas, o formato e aperte o botão verde para baixar os dados de cada presidente. ⬇
            </h6>

            <form id="downloadForm">
                <div class="controls">
                    <div class="format-selector president-selector-container">
                        <label for="presidentSelect">Presidente:</label>
                        <select id="presidentSelect" name="presidentSelect">
                            <option value="lula">Lula</option>
                            <option value="bolsonaro">Bolsonaro</option>
                            <option value="temer">Temer</option>
                            <option value="dilma">Dilma</option>
                        </select>
                    </div>

                    <div class="date-picker">
                        <label for="startDate">Início:</label>
                        <input type="date" id="startDate" name="startDate" min="2023-01-01" required />
                    </div>

                    <div class="date-picker">
                        <label for="endDate">Fim:</label>
                        <input type="date" id="endDate" name="endDate" required />
                    </div>

                    <div class="format-selector">
                        <label for="fileFormat">Formato:</label>
                        <select id="fileFormat" name="fileFormat">
                            <option value="csv">CSV</option>
                            <option value="xlsx">XLSX</option>
                        </select>
                    </div>

                    <button type="submit" id="downloadBtn">Download 📥</button>
                </div>
            </form>

            <div id="message"></div>
        </main>

        <div class="divider"></div>

        <div id="search-section" class="search-container">
            <h2>Busque aqui 🔎</h2>
            <div class="search-controls">
                <div class="format-selector">
                    <label for="searchPresident">Presidente:</label>
                    <select id="searchPresident">
                        <option value="lula">Lula</option>
                        <option value="bolsonaro">Bolsonaro</option>
                        <option value="temer">Temer</option>
                        <option value="dilma">Dilma</option>
                    </select>
                </div>
                <div class="format-selector">
                    <label for="searchField">Escolha:</label>
                    <select id="searchField"></select>
                </div>

                <div class="search-input-wrapper">
                    <label for="searchInput" style="visibility: hidden;">Busque aqui:</label>
                    <input type="text" id="searchInput" placeholder="Digite aqui">
                </div>
            </div>
        </div>

        <div id="results"></div>

        <div class="divider"></div>

        <div id="quiz-section" class="content-section">
            <h2>Quiz 🧩</h2>
            <div id="quiz-container"></div>
        </div>

        <div class="divider"></div>

        <div id="dataviz-section" class="content-section">
            <h2>Visualização dos dados 📊</h2>
            <div class="chart-navigation">
                <button id="prevChart" class="nav-btn">Anterior</button>
                <button id="nextChart" class="nav-btn">Próximo</button>
            </div>

            <div class="charts-wrapper">
                <!-- Chart 1: Bubble Chart -->
                <div class="chart" id="bubble-chart-container"></div>

                <!-- Chart 2: Altair SVG -->
                <div class="chart">
                    <img src="charts/violin_presidents.svg" alt="Altair Chart">
                </div>

                <!-- Chart 3: Altair SVG -->
                <div class="chart">
                    <img src="charts/table_meetings_presidents.svg" alt="Altair Chart">
                </div>

                <!-- Chart 4: Altair SVG -->
                <div class="chart">
                    <img src="charts/barchart_month_presidents.svg" alt="Altair Chart">
                </div>
            </div>
            
            <div class="chart-dots">
                <span class="dot active"></span>
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
        </div>

    </div>

    <script>
        // =================================================================
        // CONFIGURATION
        // =================================================================
        const presidentConfig = {
            "lula": {
                fileName: "all_data.json",
                minDate: "2023-01-01",
                maxDate: getToday(),
                dateKey: "data",
                searchFields: [{ value: "participantes", text: "Participantes" }, { value: "compromisso", text: "Reunião" }],
                displayColumns: [{ header: "URL", key: "url" }, { header: "Data", key: "data" }, { header: "Agenda", key: "compromisso" }, { header: "Horário", key: "inicio" }, { header: "Local", key: "local" }, { header: "Participantes", key: "participantes" }]
            },
            "bolsonaro": {
                fileName: "bolsonaro_agenda.json",
                minDate: "2019-01-01",
                maxDate: "2022-12-31",
                dateKey: "date",
                searchFields: [{ value: "compromisso", text: "Compromisso" }],
                displayColumns: [{ header: "URL", key: "url" }, { header: "Data", key: "date" }, { header: "Horário", key: "time" }, { header: "Agenda", key: "compromisso" }, { header: "Local", key: "local" }]
            },
            "temer": {
                fileName: "temer_agenda.json",
                minDate: "2016-05-01",
                maxDate: "2018-12-31",
                dateKey: "date",
                searchFields: [{ value: "description", text: "Compromisso" }],
                displayColumns: [{ header: "URL", key: "url" }, { header: "Data", key: "date" }, { header: "Horário", key: "time" }, { header: "Agenda", key: "description" }, { header: "Local", key: "location" }]
            },
            "dilma": {
                fileName: "agenda_dilma_final.json",
                minDate: "2011-01-01",
                maxDate: "2016-06-01",
                dateKey: "data",
                searchFields: [{ value: "compromisso", text: "Compromisso" }],
                displayColumns: [{ header: "URL", key: "url" }, { header: "Data", key: "data" }, { header: "Horário", key: "horario" }, { header: "Agenda", key: "compromisso" }, { header: "Cargo", key: "cargo" }, { header: "Local", key: "local" }]
            }
        };

        // =================================================================
        // GLOBAL VARIABLES & DOM ELEMENTS
        // =================================================================
        let allData = [];
        let currentPresident = "lula";
        const startDateInput = document.getElementById("startDate");
        const endDateInput = document.getElementById("endDate");
        const downloadForm = document.getElementById("downloadForm");
        const messageDiv = document.getElementById("message");
        const searchInput = document.getElementById("searchInput");
        const resultsDiv = document.getElementById("results");
        const presidentSelect = document.getElementById("presidentSelect");
        const searchPresident = document.getElementById("searchPresident");
        const searchField = document.getElementById("searchField");

        // =================================================================
        // FUNCTIONS
        // =================================================================
        function updateDateConstraints(president) {
            const config = presidentConfig[president];
            if (!config) return;
            startDateInput.min = config.minDate;
            startDateInput.max = config.maxDate;
            endDateInput.min = config.minDate;
            endDateInput.max = config.maxDate;
            if (!startDateInput.value || startDateInput.value < config.minDate || startDateInput.value > config.maxDate) {
                startDateInput.value = config.minDate;
            }
            if (!endDateInput.value || endDateInput.value < config.minDate || endDateInput.value > config.maxDate) {
                endDateInput.value = config.maxDate;
            }
        }

        async function loadPresidentData(president) {
            messageDiv.textContent = "Loading data...";
            const config = presidentConfig[president];
            if (!config || !config.fileName) {
                messageDiv.textContent = `Error: Configuration or file for ${president} not found.`;
                messageDiv.style.color = "red";
                return [];
            }
            try {
                const response = await fetch(`data/${config.fileName}`);
                if (!response.ok) throw new Error("Network response was not ok.");
                const data = await response.json();
                messageDiv.textContent = "";
                return data;
            } catch (error) {
                messageDiv.textContent = `Error loading data: ${error.message}`;
                messageDiv.style.color = "red";
                return [];
            }
        }

        function filterByDate(start, end) {
            const { dateKey } = presidentConfig[currentPresident];
            return allData.filter(entry => entry[dateKey] >= start && entry[dateKey] <= end);
        }

        function convertToCSV(data) {
            if (data.length === 0) return "";
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(",")];
            data.forEach(row => {
                const values = headers.map(header => `"${String(row[header]).replace(/"/g, '""')}"`);
                csvRows.push(values.join(","));
            });
            return csvRows.join("\n");
        }

        function downloadBlob(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function updateSearchFieldOptions(president) {
            searchField.innerHTML = "";
            const config = presidentConfig[president];
            if (!config) return;
            config.searchFields.forEach(field => {
                const option = document.createElement("option");
                option.value = field.value;
                option.textContent = field.text;
                searchField.appendChild(option);
            });
        }

        function displayFilteredData(data) {
            if (data.length === 0) {
                resultsDiv.innerHTML = "<p>No matches found.</p>";
                return;
            }
            const config = presidentConfig[currentPresident];
            if (!config) return;
            const tableHeaders = config.displayColumns.map(col => `<th>${col.header}</th>`).join('');
            const tableRows = data.map(entry => {
                const cells = config.displayColumns.map(col => `<td>${entry[col.key] || ""}</td>`).join('');
                return `<tr>${cells}</tr>`;
            }).join('');
            resultsDiv.innerHTML = `<table><thead><tr>${tableHeaders}</tr></thead><tbody>${tableRows}</tbody></table>`;
        }

        async function handlePresidentChange(newPresident) {
            currentPresident = newPresident;
            presidentSelect.value = newPresident;
            searchPresident.value = newPresident;
            updateDateConstraints(newPresident);
            updateSearchFieldOptions(newPresident);
            allData = await loadPresidentData(newPresident);
            searchInput.value = "";
            resultsDiv.innerHTML = "";
            messageDiv.textContent = "";
        }

        // Get today's date in YYYY-MM-DD format
        function getToday() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-based
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // =================================================================
        // LOCATION NORMALIZATION
        // =================================================================
        function normalizeLocation(location) {
            return location
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // remove accents
                .replace(/\(.*?\)/g, "")                          // remove parentheses like (DF)
                .replace(/\s+/g, " ")                             // collapse spaces
                .trim()
                .toLowerCase();
        }

        // =================================================================
        // D3.JS BUBBLE CHART FUNCTION (NEW VERSION)
        // =================================================================
        function initializeBubbleChart() {
            const files = [
                "data/all_data.json",          // Lula
                "data/bolsonaro_agenda.json",  // Bolsonaro
                "data/temer_agenda.json",      // Temer
                "data/agenda_dilma_final.json" // Dilma
            ];

            Promise.all(files.map(url => d3.json(url))).then(allDatasets => {
                // 1. Combine all datasets and count location frequencies
                const locationCounts = allDatasets.flat().reduce((acc, entry) => {
                    const rawLocation = (entry.local || entry.location || "").trim();
                    if (!rawLocation || rawLocation.toLowerCase().includes("sem informação")) return acc;

                    const normalized = normalizeLocation(rawLocation);

                    if (acc[normalized]) {
                        acc[normalized].count += 1;
                    } else {
                        // Store both the count and the original raw location
                        acc[normalized] = { count: 1, originalName: rawLocation };
                    }
                    return acc;
                }, {});

                // 2. Convert map to array, sort, and get top 40
                const top40Locations = Object.entries(locationCounts)
                    .map(([normalizedName, data]) => ({
                        // Use the original name for display, but keep the normalized one for potential future use
                        location: data.originalName,
                        count: data.count
                    }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 40);

                // 3. Draw the chart with the new data
                drawLocationBubbleChart(top40Locations);

            }).catch(error => {
                console.error("Error loading data for bubble chart:", error);
                document.getElementById("bubble-chart-container").textContent = "Could not load data for the chart.";
            });
        }

        function drawLocationBubbleChart(data) {
            // --- Chart Dimensions ---
            const width = 800;
            const height = 600;

            // --- D3 Margin Convention --- // <-- STEP 1: Define margins
            const margin = { top: 60, right: 20, bottom: 20, left: 20 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            // --- Clear previous SVG and prepare container ---
            const container = d3.select("#bubble-chart-container");
            container.html("");

            // --- Create SVG ---
            // The main SVG has the full dimensions
            const svg = container.append("svg")
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("width", "100%")
                .attr("height", "auto")
                .attr("font-family", "sans-serif");
            // We remove text-anchor from here as it's set on the title itself

            // --- Create a group for the chart content --- // <-- STEP 2: Create a translated group
            // All chart elements will go inside this 'g' tag.
            // It's moved down and to the right by the margin amounts.
            const chartGroup = svg.append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);

            let tooltip = d3.select(".tooltip");
            if (tooltip.empty()) {
                tooltip = d3.select("body").append("div").attr("class", "tooltip");
            }

            // --- D3 Pack Layout ---
            const pack = d3.pack()
                .size([innerWidth, innerHeight]) // <-- STEP 3: Use inner dimensions for the layout
                .padding(5);

            const root = d3.hierarchy({ children: data })
                .sum(d => d.count)
                .sort((a, b) => b.value - a.value);

            const nodes = pack(root).leaves();

            // --- Color Scale ---
            const color = d3.scaleSequentialSqrt()
                .domain([d3.max(data, d => d.count), 0])
                .interpolator(d3.interpolateViridis);

            // --- Gradient Definitions ---
            // Gradients should be defined in the main SVG's <defs>
            const defs = svg.append("defs"); // <-- Append defs to the main svg

            // --- Draw Bubbles (Nodes) ---
            // IMPORTANT: Append the nodes to the 'chartGroup', not the 'svg'
            const node = chartGroup.selectAll("g") // <-- STEP 4: Append to chartGroup
                .data(nodes)
                .join("g")
                .attr("transform", d => `translate(${d.x + 1},${d.y + 1})`);

            node.append("circle")
                .attr("r", d => d.r)
                .attr("fill", d => color(d.data.count))
                .attr("fill-opacity", 0.9)
                .each(function (d) { d.originalR = d.r; })
                .on("mouseover", function (event, d) {
                    tooltip
                        .style("opacity", 1)
                        .html(`<strong>${d.data.location}</strong><br/>Menções: ${d.data.count}`)
                        .style("left", (event.pageX + 12) + "px")
                        .style("top", (event.pageY - 28) + "px");

                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr("r", d.originalR * 1.1); // small grow effect
                })
                .on("mousemove", function (event) {
                    tooltip
                        .style("left", (event.pageX + 12) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function (event, d) {
                    tooltip.style("opacity", 0);

                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr("r", d.originalR);
                });

            // --- Add Title --- //
            svg.append("text")
                .attr("x", width / 2) // Center horizontally in the full SVG
                .attr("y", margin.top / 2) // Position vertically in the middle of the top margin
                .attr("text-anchor", "middle")
                .style("font-size", "22px")
                .style("font-weight", "bold")
                .style("fill", "black")
                .text("Os lugares mais mencionados nas agendas");
        }


        // =================================================================
        // EVENT LISTENERS & INITIAL PAGE LOAD
        // =================================================================
        downloadForm.addEventListener("submit", (event) => {
            event.preventDefault();
            messageDiv.textContent = "";
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            const fileFormat = document.getElementById("fileFormat").value;
            if (endDate < startDate) {
                messageDiv.textContent = "Error: End date cannot be earlier than the start date.";
                messageDiv.style.color = "red";
                return;
            }
            const filteredData = filterByDate(startDateInput.value, endDateInput.value);
            if (filteredData.length === 0) {
                messageDiv.textContent = "No data found for the selected range.";
                return;
            }
            const fileName = `${currentPresident}_agenda_${startDateInput.value}_to_${endDateInput.value}`;
            if (fileFormat === "csv") {
                const csv = convertToCSV(filteredData);
                const bom = "\uFEFF";
                downloadBlob(bom + csv, `${fileName}.csv`, "text/csv;charset=utf-8;");
            } else if (fileFormat === "xlsx") {
                const worksheet = XLSX.utils.json_to_sheet(filteredData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Agenda");
                XLSX.writeFile(workbook, `${fileName}.xlsx`);
            }
            messageDiv.textContent = `Downloaded ${filteredData.length} records.`;
            messageDiv.style.color = "green";
        });

        searchInput.addEventListener("input", () => {
            const query = searchInput.value.trim().toLowerCase();
            const field = searchField.value;
            if (!query) {
                resultsDiv.innerHTML = "";
                return;
            }
            const filtered = allData.filter(entry => (entry[field] || "").toLowerCase().includes(query));
            const { dateKey } = presidentConfig[currentPresident];
            filtered.sort((a, b) => b[dateKey].localeCompare(a[dateKey]));
            displayFilteredData(filtered);
        });

        presidentSelect.addEventListener("change", () => handlePresidentChange(presidentSelect.value));
        searchPresident.addEventListener("change", () => handlePresidentChange(searchPresident.value));


        document.addEventListener("DOMContentLoaded", () => {
            // Initialize with default president
            handlePresidentChange(currentPresident);

            // Initialize bubble chart
            initializeBubbleChart();

            // Chart navigation logic
            const chartsWrapper = document.querySelector('.charts-wrapper'); // <-- 1. Get the container
            const charts = document.querySelectorAll(".chart");
            const dots = document.querySelectorAll('.chart-dots .dot');
            let currentChartIndex = 0;

            function showChart(index) {
                charts.forEach((chart, i) => {
                    chart.classList.toggle("active", i === index);
                });
                // Also update dots for desktop view
                dots.forEach((dot, i) => {
                    dot.classList.toggle("active", i === index);
                });
            }

            document.getElementById("prevChart").addEventListener("click", () => {
                currentChartIndex = (currentChartIndex - 1 + charts.length) % charts.length;
                showChart(currentChartIndex);
            });

            document.getElementById("nextChart").addEventListener("click", () => {
                currentChartIndex = (currentChartIndex + 1) % charts.length;
                showChart(currentChartIndex);
            });

            // This function updates the active dot based on the scroll position on mobile
            function updateActiveDot() {
                // Check if we are in mobile view
                if (window.innerWidth <= 768) {
                    // <-- 2. Use the wrapper for calculations
                    const chartWidth = chartsWrapper.clientWidth;
                    const currentIndex = Math.round(chartsWrapper.scrollLeft / chartWidth);

                    // Update the active class on the dots
                    dots.forEach((dot, index) => {
                        // Using toggle is a cleaner way to add/remove the class
                        dot.classList.toggle('active', index === currentIndex);
                    });
                }
            }

            // <-- 3. Add the event listener for scrolling
            chartsWrapper.addEventListener('scroll', updateActiveDot);

            // Start with the first chart and dot active
            showChart(currentChartIndex);

            // The button is now created with its own click handler.
            d3.select("#nextQuestion").on("click", setupQuiz);
            d3.select("#nextQuestion").on("click", displayRandomQuestion);
        });
    </script>

</body>

</html>